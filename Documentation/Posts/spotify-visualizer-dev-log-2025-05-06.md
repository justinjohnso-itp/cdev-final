---
title: "Dev Log: Spotify Visualizer Gets an MQTT Upgrade, New Features, and a UI!"
date: 2025-05-06
tags: ["spotify", "led visualizer", "mqtt", "arduino", "nodejs", "astro", "iot", "devlog"]
---

What a productive day for the Spotify LED Visualizer project! We've made significant strides in refactoring core components, addressing some pesky bugs, and rolling out exciting new features for both the Arduino-powered display and the web client.

## The Big Leap: HTTP to MQTT for Real-Time Responsiveness

The most significant architectural enhancement today was migrating our data flow from an HTTP polling mechanism to a more robust and efficient **MQTT-based architecture**.

Previously, the Arduino microcontroller would repeatedly poll a server endpoint to fetch the latest Spotify track information. While functional, this approach wasn't optimal for real-time updates.

The new, improved system works as follows:
*   The **Arduino sketch (`main.cpp`)** has been refactored to utilize the `ArduinoMqttClient` library. It now subscribes to a dedicated MQTT topic (`conndev/spotify-visualizer`), listening for incoming messages.
*   Our **Node.js server (`web/server/index.js`)** now takes on the role of fetching the currently playing song data from the Spotify API (securely managing API tokens via Supabase to avoid exposing sensitive credentials) and then *publishing* this data to the aforementioned MQTT topic.

This architectural shift ensures that the Arduino receives updates almost instantaneously when a song changes or playback state (play/pause) is altered. The result is a significantly more responsive and efficient visualizer, enhancing the user experience.

## Arduino Enhancements: Finer Control and Smoother Visuals

With the MQTT backbone firmly in place, we dedicated effort to refining the Arduino-powered LED matrix display:

### 1. Custom Font for Enhanced Readability
To better accommodate longer track names on our 32x8 LED matrix, we've integrated a **compact custom font (`5x5_6pt7b.h`)**. This involved:
*   Adding the new font file to the Arduino project's include directory.
*   Modifying `main.cpp` to leverage `matrix.setFont()` for applying the custom font and `matrix.getTextBounds()` for precise text width calculationsâ€”essential for smooth, accurate scrolling animations.
*   Performing minor but necessary C++ identifier renaming within the font file itself, as some auto-generated names were incompatible.

### 2. Engaging Idle Animation: A Dynamic Sine Wave
When Spotify is not actively playing music, the matrix now displays a **dynamic scrolling sine wave animation**. This provides clear visual feedback that the device is operational and awaiting data, rather than appearing inactive or off.

*How it works:*
*   The animation is generated by calculating the Y position for each column (X position) of the LED matrix using a sine function (`sin()`).
*   A `waveOffset` variable is incrementally adjusted in each animation frame, creating the illusion of the wave scrolling horizontally across the display.
*   To add more visual interest, the color of the sine wave gracefully cycles through the hue spectrum (using `matrix.ColorHSV()`), creating a subtle rainbow effect over time.
*   The animation runs at a controlled frame rate using a small `delay()` to manage its speed.

This not only makes the visualizer more engaging during periods of inactivity but also serves as a useful diagnostic indicator.

### 3. Potentiometer-Controlled Scroll Speed: Tailoring the Experience
Empowering users with more granular control, a potentiometer connected to an analog input pin (`A0`) now allows for **on-the-fly adjustment of the scrolling text speed** when a track is playing. This allows users to tailor the visual experience to their preference, whether they prefer a leisurely crawl or a speedier ticker.

*Implementation Details:*
*   The Arduino firmware continuously reads the analog value from the potentiometer (which ranges from 0 to 1023).
*   This raw analog value is then mapped to a more practical range suitable for controlling animation delay (e.g., 20ms to 200ms) using the `map()` function. A lower delay results in faster scrolling.
*   The `currentScrollDelay` variable, derived from the potentiometer's reading, is then used in the `delay()` function within the text scrolling loop, dynamically altering the speed at which the track information glides across the LED matrix.

This feature adds a welcome layer of personalization to the visualizer.

### 4. Investigating a Display Flashing Anomaly (Ongoing)
We are actively working to resolve a persistent issue where the LED matrix display **flashes momentarily when transitioning between the scrolling text (active playback) and the idle animation**.
*   Our latest diagnostic step involved ensuring `matrix.fillScreen(0)` (to clear the display buffer) is explicitly called immediately before initiating the idle animation sequence.
*   Previous attempts included removing potentially redundant `clearMatrix()` and `matrix.show()` calls from the MQTT message handler and WiFi disconnection logic. This particular challenge remains under investigation, and we're committed to finding a solution.

## Crafting a Custom Enclosure: From Digital Model to Physical Form

Beyond the software, attention was also given to the physical presentation of the Spotify LED Visualizer. A custom enclosure has been designed and fabricated to neatly house the electronics and enhance the overall aesthetic.

*   **Design Approach:** The enclosure (a 3D model of which is pictured below/referenced) aims for a clean, minimalist look, suitable for a desk or shelf.
*   **Materials & Fabrication:**
    *   **Acrylic Sandwich:** Two precisely cut pieces of acrylic are used to sandwich the LED matrix panel. This not only protects the LEDs but also acts as a diffuser, softening the light output for a more pleasant visual effect and better text legibility.
    *   **Laser-Cut Plywood Stand:** The core structure of the enclosure is a laser-cut plywood stand. This provides a stable base for the acrylic-sandwiched LED panel and includes space to discreetly house the Arduino microcontroller and other necessary electronics.

This custom-designed enclosure elevates the project from a bare-bones electronics setup to a more polished and integrated device.

## Web Client Upgrade: "Now Playing" Information Hub

The web client, built with the Astro framework, received a significant feature enhancement. The main page (`index.astro`) now proudly features a **"Now Playing" section**, offering a comprehensive overview of the user's current Spotify listening session.

Key steps in this implementation included:
1.  **New API Endpoint Creation**: We developed a new server-side API route at `/web/client/src/pages/api/spotify/current.ts`. This endpoint is responsible for fetching the latest playback state from Spotify, including robust handling for refreshing access tokens when they expire.
2.  **Frontend Integration**: The `index.astro` page was updated to:
    *   Fetch data from this new API endpoint during server-side rendering (SSR).
    *   Clearly display:
        *   Album Art (if available)
        *   Track Name
        *   Artist(s)
        *   Album Name
        *   A dynamic progress bar visually representing the current playback time against the total track duration.
        *   The name and type of the device currently playing the music (e.g., "Living Room Speaker"), along with its volume percentage.
    *   The interface has been styled with a clean, dark theme, using Spotify's signature green as an accent color for a polished look and feel.

This addition provides a much richer user experience, allowing for a quick and convenient way to check playback details without needing to switch to the Spotify application itself.

## Minor Refinements and Housekeeping
In addition to these primary developments, we performed some minor housekeeping by removing an obsolete Astro API route (`/web/client/src/pages/api/device/data.ts`) and its corresponding Netlify function configuration, keeping the codebase lean.

## Next Steps: Testing and Bug Squashing
It's been a highly productive development cycle! Our immediate priorities moving forward are:
*   **Resolve the display flashing issue** on the Arduino to ensure seamless visual transitions.
*   **Conduct comprehensive end-to-end testing** across the entire system. This is a critical phase to validate the stability and correctness of all new integrations, with a particular focus on:
    *   The reliability and performance of the MQTT communication channel under various conditions.
    *   The responsiveness and accuracy of the potentiometer-controlled scroll speed.
    *   The overall robustness and error handling of both the server and client applications after these significant architectural and feature changes.

Stay tuned for further updates as we continue to enhance the Spotify LED Visualizer!
